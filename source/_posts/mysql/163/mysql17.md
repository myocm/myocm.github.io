---
title: 数据库设计
list_number: false
categories:
  - MySQL
comments: true
description:
  - 数据库设计
date: 2016-10-27 10:34:45
updated: 2016-10-27 10:34:45
tags:
---
# 数据库设计

## 什么是Schema设计
- 设计数据库的表，索引，以及表和表的关系
  - 在数据建模的基础上将关系模型转化为数据库表
  - 满足业务模型需要基础上根据数据库和应用特点优化表结构
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027105722660.png)

## 为什么Schema需要设计
- Schema关系到应用程序功能与性能
  - 满足业务功能需要
  - 同性能密切相关
  - 数据库扩展
  - 满足周边需求（统计，迁移等）

## 由开发者主导的Schema设计
- 着眼于实现当前功能
- 完全基于功能的设计可能存在一些隐患
  - 不合理的表结构或索引设计造成性能问题
  - 没有合理评估到数据量的增长造成空间紧张而且难以维护
  - 需求频繁修改造成表结构经常变更
  - 业务重大调整导致数据经常需要重构订正
  - ......

## 基于性能的表设计
- 根据查询需要设计好索引
- 根据核心查询需求，适当调整表结构
- 基于一些特殊业务需求，调整实现方式

### 索引
- 正确使用索引
- 更新尽可能使用主题或唯一索引
- 主键尽可能使用自增ID字段
- 核心查询覆盖扫描
  - 用户登录需要更加用户名返回密码用于验证
  - 建立联合索引避免回表取数据
  create index idx_uname_passwd on tb_user(username,password);

### 反范式，冗余必要字段
- 针对核心SQL保留查询结果所必须的冗余字段，避免频繁join
  - 例：消息表中冗余了每次读消息必须返回的nickname字段，避免每次读消息都变成join操作，代价是用户修改nickname成本变高。
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-2016102711213288.png)

### 拆分大字段
- 拆分大字段到单独表中，避免范围扫描代价大
  - 例：博文表拆分两份，标题表只保留标题和内容简介部分，用于快速批量返回标题列表，正文表保存大段博文内容，用于点开文章单个读取。
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027112924165.png)

### 避免过多字段或过长行
- 根据SQL必要返回设计字段，有必要就拆表，避免过多字段
- 一次没有必要获取那么多列数据
- 行过长导致表数据页记录变少，范围扫描性能降低
- 更新数据页代价增加
- 16K页最少放2行，可能出现行迁移

### 分页查询
- 避免limit+offset过大
- 应该使用自增主键ID模拟分页
  1. 第一页，直接查
  2. 得到第一页的max(id)=123 (一般是最后一条记录)
  3. 第二页，带上id>123 查询： where id>123 limit 100  
  这样每次只需要扫描100条数据
- 要求业务上禁止查询XXX页之后的数据

### 热点读数据特殊处理
- 根据数据获取的频率或数量不同对热点数据做特殊处理
  - 例：论坛系统中的置顶帖，公告贴，可以单独拆分存储，由于每次访问都要全部都出来，单独放一起，避免每次都到普通表中随机找出来
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027141300791.png)

### 热点写数据特殊处理
- 根据数据获取的频率或数量不同对热点数据做特殊处理
  - 例：微博系统中对大量人关注的热点账号消息从“推”改为“拉”，避免过量insert操作
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027141935301.png)

### 准实时统计
- 对不需要精确结果的计数等统计要求，建立定期更新结果表
  - 例：首页要求展示动态成交总金额，维护一个计数表，每分钟根据原注册时间获取增量sum值更新计数表，避免每次用户刷新都要扫描交易全记录表
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027143127271.png)

### 实时统计改进1--触发器实时统计
- 对需要精确统计的计数利用数据库触发器维护计数表
  - 例：用户量冲亿活动要求实时统计，用户表上加触发器，每次有新用户插入就同时在计数表+1
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027143529160.png)

### 实时统计改进2--缓存实时统计
- 对需要精确统计的计数利用前端缓存实时维护计数
  - 例：用户量冲亿活动要求实时统计，注册数量在缓存中实时维护，每注册一个就+1，完全避免数据库读写操作，缓存万一故障失效，可从数据库整体count重新获取
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027143903753.png)

### 实时统计改进3--最大自增ID获取总数
- 很多逻辑可以利用自增ID主键最大值直接作为总数
  - 例：用户量冲亿活动要求实时统计，用户表上加上自增ID作为主键，只要取当时max(ID)就可以得到用户总数
  ![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027144121631.png)

### 可扩展性设计
- 可扩展性
  - 硬件资源增长有极限的情况下处理尽可能久的线上业务
- 数据分级，冷数据归档与淘汰
  - 可以不断释放空间供新数据使用
- 为数据分布式做准备
  - 分库分表
  - 水平拆分
  - 牺牲一定的关系模型支持

### 分区表与数据淘汰
- range分区
- 适合数据需要定期过期的大表
- 单个分区扫描迁移数据到历史库避免全表扫描IO开销
- 删除单个分区非常高效  
![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027145305114.png)

### 分区表与垂直分区
- list分区
- 适合将来可能要基于地区，类目等方式垂直拆分数据的方式
- 清理节点上不要的数据非常高效  
![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027145442174.png)

### 分区表与水平分区
- hash分区
- 适合将来需要做水平拆分的表
- 清理节点上不要的数据非常高效  
![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027145650258.png)

### MySQL分区表的局限
- 主键或唯一键必须包含在分区字段内
- 分区字段必须是整数类型，或者加上返回整数的函数


### 满足周边需求
- 为周边需求额外增加表设计
  - 为后台统计任务增加特殊索引
  - 为数据迁移或统计需求增加时间戳


#### 统计和后台需求
- 统计运行SQL往往和线上有很大不同
  - 利用MySQL一主多从，主从可以建不同索引的特性将统计分流到特定库
  - 包括一些特殊用户批量查询等，所有对线上有IO压力的查询都要读写分离

#### 自动更新时间戳
- 统计需求经常要求从线上读走增量数据
- 表的第一个timestamp类型字段在写入时如果不填值，会自动写入系统时间戳
- 表的第一个timestamp类型字段每次记录发生更新后都会自动更新
- 在update_time字段上建索引用于定时导出增量数据
![](http://ocaw8wyva.bkt.clouddn.com/markdown-img-paste-20161027152222657.png)

#### Schema设计与前瞻性
- 基于历史经验教训，预防和解决同类问题
- 把折腾DBA够呛的所有Schema改造的原因记录并分析总结
例：
  - 业务为了用户信息加密做了大改造
    - 数据库结果大量改动，增加了加密字段，验证策略表，所有表重新订正数据等等
    - 是否所有用的用户信息管理的应用都要去上线就用密文？
  - 程序bug误删数据，线上风险大
    - 改造业务流程，不再删除数据，加入is_deleted标识位，经常给各种表加
    - 今后的类似表是否一上线就都用标志位的方式，并加上修改原因字段？
  - 支付类应用后期做了风控改造
    - 对线上订单大表改造，加了限额，终端类型等字段
    - 遇到支付类应用，是否一上线就提示业务是否需要考虑风控并留好相关字段？



----
Good luck!  
冬日暖阳
