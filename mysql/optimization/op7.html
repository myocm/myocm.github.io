
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta name="baidu-site-verification" content="ls1TMwmUrj">
  <meta charset="UTF-8">
  
    <title>MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除 | MyDBA学习笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="冬日暖阳">
    

    
    <meta name="description" content="MySQL优化">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除">
<meta property="og:url" content="http://mydba.xyz/mysql/optimization/op7.html">
<meta property="og:site_name" content="MyDBA学习笔记">
<meta property="og:description" content="MySQL优化">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://mydba.xyz/img/markdown-img-paste-20180104153553920.png">
<meta property="og:updated_time" content="2018-01-03T07:18:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除">
<meta name="twitter:description" content="MySQL优化">
<meta name="twitter:image" content="http://mydba.xyz/img/markdown-img-paste-20180104153553920.png">
<meta name="twitter:creator" content="@sdy0917">

    
    <link rel="alternative" href="/atom.xml" title="MyDBA学习笔记" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="MyDBA学习笔记" title="MyDBA学习笔记"></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="MyDBA学习笔记">MyDBA学习笔记</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
						<form class="search" action="http://znsv.baidu.com/customer_search/api/js" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value="16079030559689052000"><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope="" itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/mysql/optimization/op7.html" title="MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除" itemprop="url">MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="冬日暖阳" target="_blank" itemprop="author">冬日暖阳</a>
		
  </p><p class="article-time">
    <time datetime="2018-01-03T07:18:04.000Z" itemprop="datePublished"> 发表于 2018-01-03</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#外连接消除、连接消除与嵌套连接消除"><span class="toc-text">外连接消除、连接消除与嵌套连接消除</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Outer-Join-Elimination"><span class="toc-text">Outer Join Elimination</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-Outer-Join"><span class="toc-text">What is Outer Join ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-type-of-Outer-Join"><span class="toc-text">The type of Outer Join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-does-Outer-Join-Elimination"><span class="toc-text">Why does Outer Join Elimination ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-Outer-Join-Elimination-for-MySQL"><span class="toc-text">How to do Outer Join Elimination for MySQL ?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Join-Elimination"><span class="toc-text">Join Elimination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest-Join-Elimination"><span class="toc-text">Nest Join Elimination</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="外连接消除、连接消除与嵌套连接消除"><a href="#外连接消除、连接消除与嵌套连接消除" class="headerlink" title="外连接消除、连接消除与嵌套连接消除"></a>外连接消除、连接消除与嵌套连接消除</h1><p>Outer Join Elimination、 Join Elimination、 Nest Join Elimination</p>
<h2 id="Outer-Join-Elimination"><a href="#Outer-Join-Elimination" class="headerlink" title="Outer Join Elimination"></a>Outer Join Elimination</h2><h3 id="What-is-Outer-Join"><a href="#What-is-Outer-Join" class="headerlink" title="What is Outer Join ?"></a>What is Outer Join ?</h3><p><img src="/img/markdown-img-paste-20180104153553920.png" alt="外连接"></p>
<p>内连接为：A 表和 B 表都满足连接条件的部分。<br>外连接为：A 表和 B 表都满足连接条件的部分 加上 A 满足连接条件而 B 不满足连接条件的部分。（A 为主连接表的情况）。  </p>
<h3 id="The-type-of-Outer-Join"><a href="#The-type-of-Outer-Join" class="headerlink" title="The type of Outer Join"></a>The type of Outer Join</h3><ol>
<li>LEFT JOIN / LEFT OUTER JOIN：左外连接<br>左向外连接的结果集包括：LEFT OUTER子句中指定的左表的所有行，而不仅仅是连接列所匹配的行。如果左表的某行在右表中没有匹配行，则在相关联的结果集行中右表的所有选择列表列均为空值。       </li>
<li>RIGHT JOIN / RIGHT  OUTER  JOIN：右外连接<br>右向外连接是左向外联接的反向连接。将返回右表的所有行。如果右表的某行在左表中没有匹配行，则将为左表返回空值。       </li>
<li>FULL JOIN / FULL OUTER JOIN：全外连接<br>全外连接返回左表和右表中的所有行。当某行在另一个表中没有匹配行时，则另一个表的选择列表列包含空值。如果表之间有匹配行，则整个结果集行包含基表的数据值。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> book ;</span><br><span class="line">+<span class="comment">--------+------------------+-----------+</span></span><br><span class="line">| bookid | bookname         | studentid |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+</span></span><br><span class="line">|      1 | &lt;&lt;培训&gt;&gt;         |         3 |</span><br><span class="line">|      2 | &lt;&lt;成功秘诀&gt;&gt;     |         5 |</span><br><span class="line">|      3 | &lt;&lt;红楼梦&gt;&gt;       |         3 |</span><br><span class="line">|      4 | &lt;&lt;西厢记&gt;&gt;       |         2 |</span><br><span class="line">|      5 | &lt;&lt;水浒传&gt;&gt;       |         6 |</span><br><span class="line">|      6 | &lt;&lt;三国演义&gt;&gt;     |        10 |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student ;</span><br><span class="line">+<span class="comment">-----------+--------------+</span></span><br><span class="line">| studentid | stundentname |</span><br><span class="line">+<span class="comment">-----------+--------------+</span></span><br><span class="line">|         1 | 张三         |</span><br><span class="line">|         2 | 李四         |</span><br><span class="line">|         3 | 关羽         |</span><br><span class="line">|         4 | 张飞         |</span><br><span class="line">|         5 | 黄聪         |</span><br><span class="line">|         6 | 李逵         |</span><br><span class="line">|         7 | 赵娜         |</span><br><span class="line">|         8 | 王萌         |</span><br><span class="line">+<span class="comment">-----------+--------------+</span></span><br><span class="line"><span class="comment">-- 内连接</span></span><br><span class="line">root@127.0.0.1 [op]&gt; SELECT *</span><br><span class="line">    -&gt; FROM book AS b, student AS s</span><br><span class="line">    -&gt; WHERE b.studentid=s.studentid</span><br><span class="line">    -&gt;  ;</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">| bookid | bookname         | studentid | studentid | stundentname |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">|      4 | &lt;&lt;西厢记&gt;&gt;       |         2 |         2 | 李四         |</span><br><span class="line">|      1 | &lt;&lt;培训&gt;&gt;         |         3 |         3 | 关羽         |</span><br><span class="line">|      3 | &lt;&lt;红楼梦&gt;&gt;       |         3 |         3 | 关羽         |</span><br><span class="line">|      2 | &lt;&lt;成功秘诀&gt;&gt;     |         5 |         5 | 黄聪         |</span><br><span class="line">|      5 | &lt;&lt;水浒传&gt;&gt;       |         6 |         6 | 李逵         |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 左外连接</span></span><br><span class="line">root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> [op]&gt; <span class="keyword">SELECT</span> *</span><br><span class="line">    -&gt; <span class="keyword">FROM</span> book <span class="keyword">AS</span> b <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> student <span class="keyword">AS</span> s</span><br><span class="line">    -&gt; <span class="keyword">ON</span> b.studentid=s.studentid</span><br><span class="line">    -&gt; ;</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">| bookid | bookname         | studentid | studentid | stundentname |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">|      4 | &lt;&lt;西厢记&gt;&gt;       |         2 |         2 | 李四         |</span><br><span class="line">|      1 | &lt;&lt;培训&gt;&gt;         |         3 |         3 | 关羽         |</span><br><span class="line">|      3 | &lt;&lt;红楼梦&gt;&gt;       |         3 |         3 | 关羽         |</span><br><span class="line">|      2 | &lt;&lt;成功秘诀&gt;&gt;     |         5 |         5 | 黄聪         |</span><br><span class="line">|      5 | &lt;&lt;水浒传&gt;&gt;       |         6 |         6 | 李逵         |</span><br><span class="line">|      6 | &lt;&lt;三国演义&gt;&gt;     |        10 |      NULL | NULL         |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">-- 右外连接</span></span><br><span class="line">root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> [op]&gt; <span class="keyword">SELECT</span> *</span><br><span class="line">    -&gt; <span class="keyword">FROM</span> book <span class="keyword">AS</span> b <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span></span><br><span class="line">    -&gt; student <span class="keyword">AS</span> s</span><br><span class="line">    -&gt; <span class="keyword">ON</span> b.studentid=s.studentid</span><br><span class="line">    -&gt; ;</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">| bookid | bookname         | studentid | studentid | stundentname |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">|      1 | &lt;&lt;培训&gt;&gt;         |         3 |         3 | 关羽         |</span><br><span class="line">|      2 | &lt;&lt;成功秘诀&gt;&gt;     |         5 |         5 | 黄聪         |</span><br><span class="line">|      3 | &lt;&lt;红楼梦&gt;&gt;       |         3 |         3 | 关羽         |</span><br><span class="line">|      4 | &lt;&lt;西厢记&gt;&gt;       |         2 |         2 | 李四         |</span><br><span class="line">|      5 | &lt;&lt;水浒传&gt;&gt;       |         6 |         6 | 李逵         |</span><br><span class="line">|   NULL | NULL             |      NULL |         4 | 张飞         |</span><br><span class="line">|   NULL | NULL             |      NULL |         7 | 赵娜         |</span><br><span class="line">|   NULL | NULL             |      NULL |         8 | 王萌         |</span><br><span class="line">|   NULL | NULL             |      NULL |         1 | 张三         |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line"><span class="comment">-- 全外连接(MySQL 还不支持 FULL OUTER JOIN)</span></span><br><span class="line"><span class="comment">-- 可以通过合并左外连接和右外连接等价于全外连接</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> book <span class="keyword">AS</span> b</span><br><span class="line">    -&gt; <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> student <span class="keyword">AS</span> s</span><br><span class="line">    -&gt; <span class="keyword">ON</span> b.studentid=s.studentid</span><br><span class="line">    -&gt; <span class="keyword">UNION</span></span><br><span class="line">    -&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> book <span class="keyword">AS</span> b</span><br><span class="line">    -&gt; <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> student <span class="keyword">AS</span> s</span><br><span class="line">    -&gt; <span class="keyword">ON</span> b.studentid=s.studentid ;</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">| bookid | bookname         | studentid | studentid | stundentname |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br><span class="line">|      4 | &lt;&lt;西厢记&gt;&gt;       |         2 |         2 | 李四         |</span><br><span class="line">|      1 | &lt;&lt;培训&gt;&gt;         |         3 |         3 | 关羽         |</span><br><span class="line">|      3 | &lt;&lt;红楼梦&gt;&gt;       |         3 |         3 | 关羽         |</span><br><span class="line">|      2 | &lt;&lt;成功秘诀&gt;&gt;     |         5 |         5 | 黄聪         |</span><br><span class="line">|      5 | &lt;&lt;水浒传&gt;&gt;       |         6 |         6 | 李逵         |</span><br><span class="line">|      6 | &lt;&lt;三国演义&gt;&gt;     |        10 |      NULL | NULL         |</span><br><span class="line">|   NULL | NULL             |      NULL |         4 | 张飞         |</span><br><span class="line">|   NULL | NULL             |      NULL |         7 | 赵娜         |</span><br><span class="line">|   NULL | NULL             |      NULL |         8 | 王萌         |</span><br><span class="line">|   NULL | NULL             |      NULL |         1 | 张三         |</span><br><span class="line">+<span class="comment">--------+------------------+-----------+-----------+--------------+</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>自然连接<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@127.0.0.1 [op]&gt; SELECT * FROM book</span><br><span class="line">    -&gt; NATURAL LEFT OUTER JOIN student ;</span><br><span class="line">+<span class="comment">-----------+--------+------------------+--------------+</span></span><br><span class="line">| studentid | bookid | bookname         | stundentname |</span><br><span class="line">+<span class="comment">-----------+--------+------------------+--------------+</span></span><br><span class="line">|         2 |      4 | &lt;&lt;西厢记&gt;&gt;       | 李四         |</span><br><span class="line">|         3 |      1 | &lt;&lt;培训&gt;&gt;         | 关羽         |</span><br><span class="line">|         3 |      3 | &lt;&lt;红楼梦&gt;&gt;       | 关羽         |</span><br><span class="line">|         5 |      2 | &lt;&lt;成功秘诀&gt;&gt;     | 黄聪         |</span><br><span class="line">|         6 |      5 | &lt;&lt;水浒传&gt;&gt;       | 李逵         |</span><br><span class="line">|        10 |      6 | &lt;&lt;三国演义&gt;&gt;     | NULL         |</span><br><span class="line">+<span class="comment">-----------+--------+------------------+--------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">--</span></span><br><span class="line">root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> [op]&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> book</span><br><span class="line">    -&gt; <span class="keyword">NATURAL</span> <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> student  ;</span><br><span class="line">+<span class="comment">-----------+--------------+--------+------------------+</span></span><br><span class="line">| studentid | stundentname | bookid | bookname         |</span><br><span class="line">+<span class="comment">-----------+--------------+--------+------------------+</span></span><br><span class="line">|         3 | 关羽         |      1 | &lt;&lt;培训&gt;&gt;         |</span><br><span class="line">|         5 | 黄聪         |      2 | &lt;&lt;成功秘诀&gt;&gt;     |</span><br><span class="line">|         3 | 关羽         |      3 | &lt;&lt;红楼梦&gt;&gt;       |</span><br><span class="line">|         2 | 李四         |      4 | &lt;&lt;西厢记&gt;&gt;       |</span><br><span class="line">|         6 | 李逵         |      5 | &lt;&lt;水浒传&gt;&gt;       |</span><br><span class="line">|         4 | 张飞         |   NULL | NULL             |</span><br><span class="line">|         7 | 赵娜         |   NULL | NULL             |</span><br><span class="line">|         8 | 王萌         |   NULL | NULL             |</span><br><span class="line">|         1 | 张三         |   NULL | NULL             |</span><br><span class="line">+<span class="comment">-----------+--------------+--------+------------------+</span></span><br><span class="line">9 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="Why-does-Outer-Join-Elimination"><a href="#Why-does-Outer-Join-Elimination" class="headerlink" title="Why does Outer Join Elimination ?"></a>Why does Outer Join Elimination ?</h3><p>外连接消除：</p>
<p>把外连接变为内连接<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A OUTER JOIN B</span><br><span class="line">变形为</span><br><span class="line">A JOIN B</span><br></pre></td></tr></table></figure></p>
<p>外连接消除的意义：  </p>
<ol>
<li>查询优化器在处理外连接操作时所需执行的操作和时间多于内连接</li>
<li>外连接消除后，优化器在选择多表连接顺序时，可以有更多更灵活的选择，从而可以选择更好的表连接顺序，加快查询执行的速度</li>
<li>表的一些连接算法（如块嵌套连接和索引循环连接等）在将规模小的或筛选条件最严格的表作为“外表”（放在连接顺序的最前面，是多层循环体的外循环层），可以减少不必要的I/O开销，能加快算法执行的速度</li>
</ol>
<h3 id="How-to-do-Outer-Join-Elimination-for-MySQL"><a href="#How-to-do-Outer-Join-Elimination-for-MySQL" class="headerlink" title="How to do Outer Join Elimination for MySQL ?"></a>How to do Outer Join Elimination for MySQL ?</h3><p>外连接消除的条件：<br>WHERE子句中的条件满足“空值拒绝”<br>（又称为“reject-NULL”条件）。  </p>
<blockquote>
<p>WHERE条件可以保证从结果中排除外连接右侧（右表）生成的值为NULL的行（即条件确保应用在右表带有空值的列对象上时，条件不满足，条件的结果值为FLASE或UNKONOWEN，这样右表就不会有值为NULL的行生成），所以能使该查询在语义上等效于内连接。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> X <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Y <span class="keyword">ON</span> (X.X_num=Y.Y_num)</span><br><span class="line"><span class="keyword">WHERE</span> Y.Y_num <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>示例:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表，命令如下：</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_1 (t_1_id <span class="built_in">INT</span> <span class="keyword">UNIQUE</span>, t_1_col_1 <span class="built_in">INT</span>, t_1_col_2 <span class="built_in">VARCHAR</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_2 (t_2_id <span class="built_in">INT</span> <span class="keyword">UNIQUE</span>, t_2_col_1 <span class="built_in">INT</span>, t_2_col_2 <span class="built_in">VARCHAR</span>(<span class="number">10</span>));</span><br><span class="line"><span class="comment">-- 插入数据，命令如下：</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">11</span>, <span class="string">'t_1_1'</span>);   <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">12</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="literal">NULL</span>, <span class="string">'t_1_3'</span>); <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">14</span>, <span class="string">'t_1_4'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">15</span>, <span class="literal">NULL</span>);      <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_1 <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">11</span>, <span class="string">'t_2_1'</span>);   <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="literal">NULL</span>, <span class="string">'t_2_2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">13</span>, <span class="literal">NULL</span>);      <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">14</span>, <span class="string">'t_2_4'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">16</span>, <span class="string">'t_2_6'</span>);   <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_2 <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">语句一，使用TRUE作为ON的子句，WHERE子句包括连接条件：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> <span class="literal">true</span> <span class="keyword">WHERE</span> t_1_id = t_2_id;</span><br><span class="line"></span><br><span class="line">语句二，使用ON子句包括连接条件：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id;</span><br><span class="line"></span><br><span class="line">语句三，使用ON和WHERE子句包括连接条件：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id <span class="keyword">WHERE</span> t_1_id = t_2_id;</span><br><span class="line"></span><br><span class="line">从执行结果看：</span><br><span class="line">语句一，三：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> <span class="literal">true</span> <span class="keyword">WHERE</span> t_1_id = t_2_id;</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">| t_1_id | t_1_col_1 | t_1_col_2 | t_2_id | t_2_col_1 | t_2_col_2 |</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">|      1 |        11 | t_1_1     |      1 |        11 | t_2_1     |</span><br><span class="line">|      2 |        12 | NULL      |      2 |      NULL | t_2_2     |</span><br><span class="line">|      3 |      NULL | t_1_3     |      3 |        13 | NULL      |</span><br><span class="line">|      4 |        14 | t_1_4     |      4 |        14 | t_2_4     |</span><br><span class="line">|      7 |      NULL | NULL      |      7 |      NULL | NULL      |</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">语句二：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id;</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">| t_1_id | t_1_col_1 | t_1_col_2 | t_2_id | t_2_col_1 | t_2_col_2 |</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">|      1 |        11 | t_1_1     |      1 |        11 | t_2_1     |</span><br><span class="line">|      2 |        12 | NULL      |      2 |      NULL | t_2_2     |</span><br><span class="line">|      3 |      NULL | t_1_3     |      3 |        13 | NULL      |</span><br><span class="line">|      4 |        14 | t_1_4     |      4 |        14 | t_2_4     |</span><br><span class="line">|      5 |        15 | NULL      |   NULL |      NULL | NULL      |</span><br><span class="line">|      7 |      NULL | NULL      |      7 |      NULL | NULL      |</span><br><span class="line">+<span class="comment">--------+-----------+-----------+--------+-----------+-----------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">可以发现，语句一，三的 <span class="keyword">where</span> 可以保证从结果集中排除外连接右侧（右表）生成的值为 <span class="literal">NULL</span> 的行</span><br><span class="line"></span><br><span class="line">从执行计划看：</span><br><span class="line">语句二：</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key    | key_len | ref           | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | t_1   | NULL       | ALL  | NULL          | NULL   | NULL    | NULL          |    6 |   100.00 | NULL  |</span><br><span class="line">|  1 | SIMPLE      | t_2   | NULL       | ref  | t_2_id        | t_2_id | 5       | op.t_1.t_1_id |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_id`</span> <span class="keyword">AS</span> <span class="string">`t_1_id`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_col_1`</span> <span class="keyword">AS</span> <span class="string">`t_1_col_1`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_col_2`</span> <span class="keyword">AS</span> <span class="string">`t_1_col_2`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_id`</span> <span class="keyword">AS</span> <span class="string">`t_2_id`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_col_1`</span> <span class="keyword">AS</span> <span class="string">`t_2_col_1`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_col_2`</span> <span class="keyword">AS</span> <span class="string">`t_2_col_2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="string">`op`</span>.<span class="string">`t_1`</span> <span class="keyword">left</span> <span class="keyword">join</span> <span class="string">`op`</span>.<span class="string">`t_2`</span></span><br><span class="line"><span class="keyword">on</span>((<span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_id`</span> = <span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_id`</span>))</span><br><span class="line"><span class="keyword">where</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">语句一，语句三，执行计划相同：</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> <span class="literal">true</span> <span class="keyword">WHERE</span> t_1_id = t_2_id;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key    | key_len | ref           | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | t_1   | NULL       | ALL  | t_1_id        | NULL   | NULL    | NULL          |    6 |   100.00 | NULL  |</span><br><span class="line">|  1 | SIMPLE      | t_2   | NULL       | ref  | t_2_id        | t_2_id | 5       | op.t_1.t_1_id |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------+</span></span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_id`</span> <span class="keyword">AS</span> <span class="string">`t_1_id`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_col_1`</span> <span class="keyword">AS</span> <span class="string">`t_1_col_1`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_col_2`</span> <span class="keyword">AS</span> <span class="string">`t_1_col_2`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_id`</span> <span class="keyword">AS</span> <span class="string">`t_2_id`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_col_1`</span> <span class="keyword">AS</span> <span class="string">`t_2_col_1`</span>,</span><br><span class="line"><span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_col_2`</span> <span class="keyword">AS</span> <span class="string">`t_2_col_2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="string">`op`</span>.<span class="string">`t_1`</span> <span class="keyword">join</span> <span class="string">`op`</span>.<span class="string">`t_2`</span></span><br><span class="line"><span class="keyword">where</span> (<span class="string">`op`</span>.<span class="string">`t_2`</span>.<span class="string">`t_2_id`</span> = <span class="string">`op`</span>.<span class="string">`t_1`</span>.<span class="string">`t_1_id`</span>)</span><br><span class="line"></span><br><span class="line">优化器消除了外连接，变成了内连接。</span><br></pre></td></tr></table></figure></p>
<p>辨析 <code>ON</code> 和 <code>WHERE</code> 的差异:<br><code>ON   t_1_id = t_2_id</code><br>t_1_id 和 t_2_id 进行连接  </p>
<p><code>WHERE t_1_id = t_2_id</code><br>当t_1_id 和 t_2_id的值相等  </p>
<p>示例2：理解 WHERE 条件对外连接优化的影响<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">sql4：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id <span class="keyword">WHERE</span> t_1_id&gt;<span class="number">0</span>;</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">| t_1_id | t_1_col_1 | t_1_col_2 | t_2_id | t_2_col_1 | t_2_col_2 |</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">|      1 |        11 | t_1_1     |      1 |        11 | t_2_1     |</span><br><span class="line">|      2 |        12 | NULL      |      2 |      NULL | t_2_2     |</span><br><span class="line">|      3 |      NULL | t_1_3     |      3 |        13 | NULL      |</span><br><span class="line">|      4 |        14 | t_1_4     |      4 |        14 | t_2_4     |</span><br><span class="line">|      5 |        15 | NULL      |   NULL |      NULL | NULL      |</span><br><span class="line">|      7 |      NULL | NULL      |      7 |      NULL | NULL      |</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">sql5：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id <span class="keyword">WHERE</span> t_2_id&gt;<span class="number">0</span>;</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">| t_1_id | t_1_col_1 | t_1_col_2 | t_2_id | t_2_col_1 | t_2_col_2 |</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">|      1 |        11 | t_1_1     |      1 |        11 | t_2_1     |</span><br><span class="line">|      2 |        12 | NULL      |      2 |      NULL | t_2_2     |</span><br><span class="line">|      3 |      NULL | t_1_3     |      3 |        13 | NULL      |</span><br><span class="line">|      4 |        14 | t_1_4     |      4 |        14 | t_2_4     |</span><br><span class="line">|      7 |      NULL | NULL      |      7 |      NULL | NULL      |</span><br><span class="line">+--------+-----------+-----------+--------+-----------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">执行计划：</span><br><span class="line">sql4：</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id <span class="keyword">WHERE</span> t_1_id&gt;<span class="number">0</span>;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key    | key_len | ref           | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | t_1   | NULL       | ALL  | t_1_id        | NULL   | NULL    | NULL          |    6 |   100.00 | Using where |</span><br><span class="line">|  1 | SIMPLE      | t_2   | NULL       | ref  | t_2_id        | t_2_id | 5       | op.t_1.t_1_id |    1 |   100.00 | NULL        |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_id`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_col_1`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_col_1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_col_2`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_col_2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_id`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_id`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_col_1`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_col_1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_col_2`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_col_2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span> <span class="keyword">left</span> <span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`t_2`</span></span><br><span class="line"><span class="keyword">on</span>((<span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_id`</span> = <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span>))</span><br><span class="line"><span class="keyword">where</span> (<span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span> &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">sql5：</span><br><span class="line"><span class="keyword">explain</span>  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_2 <span class="keyword">ON</span> t_1_id = t_2_id <span class="keyword">WHERE</span> t_2_id&gt;<span class="number">0</span>;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key    | key_len | ref           | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | t_1   | NULL       | ALL  | t_1_id        | NULL   | NULL    | NULL          |    6 |   100.00 | Using where |</span><br><span class="line">|  1 | SIMPLE      | t_2   | NULL       | ref  | t_2_id        | t_2_id | 5       | op.t_1.t_1_id |    1 |   100.00 | NULL        |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+---------------+------+----------+-------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_id`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_col_1`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_col_1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_col_2`</span> <span class="keyword">AS</span> <span class="symbol">`t_1_col_2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_id`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_id`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_col_1`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_col_1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_col_2`</span> <span class="keyword">AS</span> <span class="symbol">`t_2_col_2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span> <span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`t_2`</span></span><br><span class="line"><span class="keyword">where</span> ((<span class="symbol">`op`</span>.<span class="symbol">`t_2`</span>.<span class="symbol">`t_2_id`</span> = <span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span>) <span class="keyword">and</span> (<span class="symbol">`op`</span>.<span class="symbol">`t_1`</span>.<span class="symbol">`t_1_id`</span> &gt; <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">可以看到 sql5 消除了外连接。</span><br></pre></td></tr></table></figure></p>
<p>外连接消除总结:</p>
<ol>
<li><p>注意外连接与内连接的语义差别</p>
</li>
<li><p>外连接优化的条件：空值拒绝</p>
</li>
<li><p>外连接优化的本质：语义上是外连接，但WHER条件使得外连接可以蜕化为内连接</p>
</li>
</ol>
<h2 id="Join-Elimination"><a href="#Join-Elimination" class="headerlink" title="Join Elimination"></a>Join Elimination</h2><p>连接消除：<br>去掉不必要的连接对象，则减少了连接操作</p>
<p>连接消除的条件：<br>无固定模式，需要具体分析</p>
<p>连接消除情况一：<br>唯一键/主键作为连接条件，三表内连接，中间表的列只作为连接条件，则可以去掉中间表</p>
<p>CREATE TABLE A (a1 INT UNIQUE, a2 VARCHAR(9), a3 INT);<br>CREATE TABLE B (b1 INT UNIQUE, b2 VARCHAR(9), c2 INT);<br>CREATE TABLE C (c1 INT UNIQUE, c2 VARCHAR(9), c3 INT);  </p>
<p>B的列在WHERE条件子句中只作为等值连接条件存在，则查询可以去掉对B的连接操作：<br>SELECT A.<code>*</code>, C.<code>*</code> FROM <strong>A JOIN B ON (a1=b1) JOIN CON (b1=c1)</strong>;<br>相当于：<br>SELECT A.<code>*</code>, C.<code>*</code> FROM <strong>A JOIN C ON (a1= c1)</strong>;  </p>
<p>连接消除情况二：<br>一些特殊形式，可以消除连接操作（可消除的表除了作为连接对象外，不出现在任何子句中）。</p>
<p>例：<br>SELECT MAX(a1) FROM A, B;<code>/* 在这样格式中的MIN、MAX函数操作可以消除连接，去掉B表不影响结果；其他聚集函数不可以 */</code><br>SELECT DISTINCT a3 FROM A, B; <code>/* 对连接结果中的a3列执行去重操作*/</code><br>SELECT a1 FROM A, B GROUP BY a1; <code>/* 对连接结果中的a1列执行分组操作 */</code>  </p>
<p>连接消除情况三：<br>主外键关系的表进行的连接，可消除主键表，这不会影响对外键表的查询。<br>例：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">创建表，命令如下：</span><br><span class="line"><span class="keyword">CREATE</span> TABLE B (b1 INT, b2 VARCHAR(<span class="number">2</span>), <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(b1));</span><br><span class="line"><span class="keyword">CREATE</span> TABLE A (a1 INT, a2 VARCHAR(<span class="number">2</span>), FOREIGN <span class="keyword">KEY</span>(a1) REFERENCES B(b1) );<span class="comment">/* A作为外键表参照主键表B */</span></span><br><span class="line"><span class="keyword">CREATE</span> TABLE C (c1 INT, c2 VARCHAR(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">插入数据，命令如下：</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> B <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'B1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> B <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'B2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> B <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">'B3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> A <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'A1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> A <span class="keyword">VALUES</span>(<span class="literal">null</span>, <span class="string">'A2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> A <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">'A3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> C <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'C1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> C <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'C2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> C <span class="keyword">VALUES</span>(<span class="literal">NULL</span>, <span class="string">'C3'</span>);</span><br><span class="line"></span><br><span class="line">对主外键参照的表进行内连接，可以消除主键表 --- MySQL不支持</span><br><span class="line">sql1:</span><br><span class="line">三个表做内连接，但目标列不包括主键表B的对象，主键表B只作为连接对象和连接条件存在  </span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,B,C <span class="keyword">WHERE</span> A.a1=B.b1 <span class="keyword">AND</span> B.b1=C.c1;</span><br><span class="line">//主键表B作为连接对象和连接条件存在</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| a1   | a2   | c1   | c2   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|    1 | A1   |    1 | C1   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPLAIN</span>  <span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,B,C <span class="keyword">WHERE</span> A.a1=B.b1 <span class="keyword">AND</span> B.b1=C.c1;</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref     | rows | filtered | Extra                                              |</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | C     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL    |    3 |   100.00 | Using where                                        |</span><br><span class="line">|  1 | SIMPLE      | A     | NULL       | ALL    | a1            | NULL    | NULL    | NULL    |    3 |    33.33 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">|  1 | SIMPLE      | B     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | op.C.c1 |    1 |   100.00 | Using <span class="keyword">index</span>                                        |</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"> <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> <span class="keyword">AS</span> <span class="symbol">`a1`</span>,</span><br><span class="line"> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a2`</span> <span class="keyword">AS</span> <span class="symbol">`a2`</span>,</span><br><span class="line"> <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">AS</span> <span class="symbol">`c1`</span>,</span><br><span class="line"> <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c2`</span> <span class="keyword">AS</span> <span class="symbol">`c2`</span></span><br><span class="line"> <span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span></span><br><span class="line"> <span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`b`</span></span><br><span class="line"> <span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`c`</span></span><br><span class="line"> <span class="keyword">where</span> ((<span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>) <span class="keyword">and</span> (<span class="symbol">`op`</span>.<span class="symbol">`b`</span>.<span class="symbol">`b1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>))</span><br><span class="line"></span><br><span class="line">sql2：</span><br><span class="line">只有表A和表C进行连接，但<span class="keyword">WHERE</span>子句多一条判定条件“A.a1 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>”；</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1 <span class="keyword">AND</span> A.a1 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>; //只有表A和C进行连接</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| a1   | a2   | c1   | c2   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|    1 | A1   |    1 | C1   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line"></span><br><span class="line">执行计划：</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1 <span class="keyword">AND</span> A.a1 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+---------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref     | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+---------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | C     | NULL       | ALL  | NULL          | NULL | NULL    | NULL    |    3 |   100.00 | Using where |</span><br><span class="line">|  1 | SIMPLE      | A     | NULL       | ref  | a1            | a1   | 5       | op.C.c1 |    1 |   100.00 | NULL        |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+---------+------+----------+-------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> <span class="keyword">AS</span> <span class="symbol">`a1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a2`</span> <span class="keyword">AS</span> <span class="symbol">`a2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">AS</span> <span class="symbol">`c1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c2`</span> <span class="keyword">AS</span> <span class="symbol">`c2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span></span><br><span class="line"><span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`c`</span></span><br><span class="line"><span class="keyword">where</span> ((<span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>) <span class="keyword">and</span> (<span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sql3：</span><br><span class="line">只有表A和表C进行连接,但<span class="keyword">WHERE</span>子句比第二条SQL的<span class="keyword">WHERE</span>子句内容更为简单</span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1;</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| a1   | a2   | c1   | c2   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|    1 | A1   |    1 | C1   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span>  <span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | C     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |   100.00 | NULL                                               |</span><br><span class="line">|  1 | SIMPLE      | A     | NULL       | ALL  | a1            | NULL | NULL    | NULL |    3 |    33.33 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> <span class="keyword">AS</span> <span class="symbol">`a1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a2`</span> <span class="keyword">AS</span> <span class="symbol">`a2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">AS</span> <span class="symbol">`c1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c2`</span> <span class="keyword">AS</span> <span class="symbol">`c2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span></span><br><span class="line"><span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`c`</span></span><br><span class="line"><span class="keyword">where</span> (<span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第一条SQL：</span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,B,C <span class="keyword">WHERE</span> A.a1=B.b1 <span class="keyword">AND</span> B.b1=C.c1;</span><br><span class="line"></span><br><span class="line">第二条SQL：</span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1 <span class="keyword">AND</span> A.a1 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">第三条SQL：</span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A,C <span class="keyword">WHERE</span> A.a1=C.c1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对主外键参照的表进行外连接，可以消除主键表  --- MySQL不支持</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> B <span class="keyword">ON</span> (a1=b1) <span class="keyword">JOIN</span> C <span class="keyword">ON</span> (a1=c1);</span><br><span class="line">表A外连接表B，然后连接表C，查询目标列没有表B的列，表B没有被消除</span><br><span class="line">+------+------+------+------+</span><br><span class="line">| a1   | a2   | c1   | c2   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|    1 | A1   |    1 | C1   |</span><br><span class="line">+------+------+------+------+</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> A.*, C.* <span class="keyword">FROM</span> A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> B <span class="keyword">ON</span> (a1=b1) <span class="keyword">JOIN</span> C <span class="keyword">ON</span> (a1=c1);</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref     | rows | filtered | Extra                                              |</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | C     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL    |    3 |   100.00 | NULL                                               |</span><br><span class="line">|  1 | SIMPLE      | A     | NULL       | ALL    | a1            | NULL    | NULL    | NULL    |    3 |    33.33 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">|  1 | SIMPLE      | B     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | op.C.c1 |    1 |   100.00 | Using <span class="keyword">index</span>                                        |</span><br><span class="line">+----+-------------+-------+------------+--------+---------------+---------+---------+---------+------+----------+----------------------------------------------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> <span class="keyword">AS</span> <span class="symbol">`a1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a2`</span> <span class="keyword">AS</span> <span class="symbol">`a2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">AS</span> <span class="symbol">`c1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c2`</span> <span class="keyword">AS</span> <span class="symbol">`c2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`b`</span> <span class="keyword">on</span>((<span class="symbol">`op`</span>.<span class="symbol">`b`</span>.<span class="symbol">`b1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>))</span><br><span class="line"><span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`c`</span></span><br><span class="line"><span class="keyword">where</span> (<span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span>)</span><br></pre></td></tr></table></figure></p>
<p>连接消除总结：  </p>
<p>注意连接消除与外连接消除的技术差别<br>连接消除去掉的是被连接的某个对象<br>外连接消除去掉的是外连接的语义，变形为内连接  </p>
<h2 id="Nest-Join-Elimination"><a href="#Nest-Join-Elimination" class="headerlink" title="Nest Join Elimination"></a>Nest Join Elimination</h2><p>嵌套连接消除：  </p>
<p>连接存在多个层次，用括号标识连接的优先次序。<br>嵌套连接消除，就是消除嵌套的连接层次，把多个层次的连接减少为较少层次的连接，尽量“扁平化”    </p>
<p>例：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">创建表，命令如下：</span><br><span class="line"><span class="keyword">CREATE</span> TABLE B (b1 INT, b2 VARCHAR(<span class="number">9</span>));</span><br><span class="line"><span class="keyword">CREATE</span> TABLE A (a1 INT, a2 VARCHAR(<span class="number">9</span>));</span><br><span class="line"><span class="keyword">CREATE</span> TABLE C (c1 INT, c2 VARCHAR(<span class="number">9</span>));</span><br><span class="line">插入数据，命令如下：</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> B <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'B1'</span>), (<span class="literal">NULL</span>, <span class="string">'B2'</span>), (<span class="number">31</span>, <span class="string">'B31'</span>), (<span class="number">32</span>, <span class="string">'B32'</span>), (<span class="literal">NULL</span>, <span class="string">'B4'</span>),(<span class="number">5</span>, <span class="string">'B5'</span>), (<span class="number">6</span>, <span class="string">'B6'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> A <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'A1'</span>), (<span class="literal">null</span>, <span class="string">'A2'</span>), (<span class="literal">NULL</span>, <span class="string">'A31'</span>), (<span class="number">32</span>, <span class="string">'A32'</span>), (<span class="number">4</span>, <span class="string">'A4'</span>), (<span class="number">5</span>, <span class="string">'A5'</span>), (<span class="literal">NULL</span>, <span class="string">'A6'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> C <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'C1'</span>), (<span class="literal">NULL</span>, <span class="string">'C2'</span>), (<span class="number">31</span>, <span class="string">'C31'</span>), (<span class="literal">NULL</span>, <span class="string">'C32'</span>), (<span class="number">4</span>, <span class="string">'C4'</span>), (<span class="literal">NULL</span>, <span class="string">'C5'</span>),(<span class="number">6</span>, <span class="string">'A6'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> A <span class="keyword">JOIN</span> (B <span class="keyword">JOIN</span> C <span class="keyword">ON</span> B.b1=C.c1) <span class="keyword">ON</span> A.a1=B.b1  <span class="keyword">WHERE</span> A.a1 &gt; <span class="number">1</span>;</span><br><span class="line">SQL语句的语义是B和C先连接，然后再和A连接</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> A <span class="keyword">JOIN</span> (B <span class="keyword">JOIN</span> C <span class="keyword">ON</span> B.b1=C.c1) <span class="keyword">ON</span> A.a1=B.b1  <span class="keyword">WHERE</span> A.a1 &gt; <span class="number">1</span>;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | A     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    7 |    33.33 | Using where                                        |</span><br><span class="line">|  1 | SIMPLE      | B     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    7 |    14.29 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">|  1 | SIMPLE      | C     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    7 |    14.29 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span><br><span class="line">优化器处理后：</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> <span class="keyword">AS</span> <span class="symbol">`a1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a2`</span> <span class="keyword">AS</span> <span class="symbol">`a2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`b`</span>.<span class="symbol">`b1`</span> <span class="keyword">AS</span> <span class="symbol">`b1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`b`</span>.<span class="symbol">`b2`</span> <span class="keyword">AS</span> <span class="symbol">`b2`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> <span class="keyword">AS</span> <span class="symbol">`c1`</span>,</span><br><span class="line"><span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c2`</span> <span class="keyword">AS</span> <span class="symbol">`c2`</span></span><br><span class="line"><span class="keyword">from</span> <span class="symbol">`op`</span>.<span class="symbol">`a`</span></span><br><span class="line"><span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`b`</span></span><br><span class="line"><span class="keyword">join</span> <span class="symbol">`op`</span>.<span class="symbol">`c`</span></span><br><span class="line"><span class="keyword">where</span> ((<span class="symbol">`op`</span>.<span class="symbol">`b`</span>.<span class="symbol">`b1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span>) <span class="keyword">and</span> (<span class="symbol">`op`</span>.<span class="symbol">`c`</span>.<span class="symbol">`c1`</span> = <span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span>) <span class="keyword">and</span> (<span class="symbol">`op`</span>.<span class="symbol">`a`</span>.<span class="symbol">`a1`</span> &gt; <span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<p>嵌套连接消除总结：</p>
<ol>
<li><p>嵌套连接消除的连接的层次,这是一种连接的语义顺序的变化</p>
</li>
<li><p>连接消除，消掉的是一些被连接的对象</p>
</li>
<li><p>外连接消除，消掉的是外连接的语义，使得外连接变形为内连接</p>
</li>
</ol>
<hr>
<p>Good luck!<br>冬日暖阳</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://mydba.xyz/mysql/optimization/op7.html" data-title="MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除 | MyDBA学习笔记" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/mysql/optimization/op8.html" title="MySQL优化 -- 8 数据库的约束规则与语义优化">
  <strong>上一篇：</strong><br>
  <span>
  MySQL优化 -- 8 数据库的约束规则与语义优化</span>
</a>
</div>


<div class="next">
<a href="/mysql/optimization/op6.html" title="MySQL优化 -- 6 条件简化">
 <strong>下一篇：</strong><br> 
 <span>MySQL优化 -- 6 条件简化
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="mysql/optimization/op7.html" data-title="MySQL优化 -- 7 外连接消除、嵌套连接消除与连接消除" data-url="http://mydba.xyz/mysql/optimization/op7.html"></div>
</section>




</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#外连接消除、连接消除与嵌套连接消除"><span class="toc-text">外连接消除、连接消除与嵌套连接消除</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Outer-Join-Elimination"><span class="toc-text">Outer Join Elimination</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-Outer-Join"><span class="toc-text">What is Outer Join ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-type-of-Outer-Join"><span class="toc-text">The type of Outer Join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-does-Outer-Join-Elimination"><span class="toc-text">Why does Outer Join Elimination ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-Outer-Join-Elimination-for-MySQL"><span class="toc-text">How to do Outer Join Elimination for MySQL ?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Join-Elimination"><span class="toc-text">Join Elimination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest-Join-Elimination"><span class="toc-text">Nest Join Elimination</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>42</sup></a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/zabbix/" title="zabbix">zabbix<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>2</sup></a></li>
		  
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">4</span></li></ul>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://www.google.com" target="_blank" title="Google">Google</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m 冬日暖阳. <br>
			Welcome to my blog.</p>
	</section>
	 
	<div class="social-font">
		
		
		
		
		<a href="https://twitter.com/sdy0917" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		
		
		
		
		
		<a href="mailto:sdy0917@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nc/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nc.svg" alt="Creative Commons">
          </a>
        </div>
    

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="冬日暖阳">冬日暖阳</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"mydba"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
